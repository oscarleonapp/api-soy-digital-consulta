<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tester API Indotel – Validación de Cédula</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --accent:#22d3ee; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background: radial-gradient(1200px 600px at 10% 0%, #111827 0%, #0b1220 40%, #070b14 100%); color: var(--fg); }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 1.6rem; letter-spacing: .2px; margin: 0 0 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size:.9rem; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select { width:100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: #0b1220; color: var(--fg); outline: none; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
    .btns { display:flex; gap:12px; flex-wrap: wrap; margin-top: 14px; }
    button { appearance:none; border:1px solid rgba(255,255,255,.14); background: #0b1220; color: var(--fg); padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.primary { background: linear-gradient(90deg, #06b6d4, #22d3ee); color:#001018; border-color: transparent; }
    button.warn { background: linear-gradient(90deg, #f59e0b, #fbbf24); color:#1b1200; border-color: transparent; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .form-block { display:flex; flex-direction:column; gap:8px; }
    .grid { display:grid; gap: 16px; margin-top: 16px; }
    .section-title { font-weight:600; margin: 10px 0 6px; color:#cbd5e1; }
    textarea { width:100%; min-height:120px; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1220; color: var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; }
    .kvs { display:grid; grid-template-columns: 220px 1fr; gap:8px; }
    .kv { display:contents; }
    .k { color: var(--muted); }
    .v { font-weight:600; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; font-size: .85rem; border:1px solid rgba(255,255,255,.12); background:#0b1220; }
    .pill.ok { border-color: rgba(16,185,129,.5); }
    .pill.warn { border-color: rgba(245,158,11,.5); }
    .pill.err { border-color: rgba(239,68,68,.5); }
    .muted { color: var(--muted); }
    .result-message { font-size:.95rem; color: var(--muted); margin-bottom: 10px; }
    .foot { margin-top: 20px; font-size:.85rem; color:var(--muted); }
    .hr { height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent); margin: 14px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .tip { font-size: .9rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tester API Indotel – Validación de Cédula</h1>

    <div class="card grid">
      <div class="section-title">Consulta de Cédula</div>
      <div class="form-block">
        <label for="cedula">Cédula (11 dígitos RD)</label>
        <input id="cedula" placeholder="Ej: 00300858230" />
        <div class="tip">Ingresa solo dígitos; la solicitud valida y limpia automáticamente la entrada.</div>
      </div>

      <div class="btns">
        <button id="btnSend" class="primary">Consultar</button>
        <button id="btnClear">Limpiar</button>
      </div>

      <div id="status" class="pill muted" style="margin-top:6px;">Listo</div>

      <div class="hr"></div>

      <div class="section-title">Resultado</div>
      <div class="result-message" id="resultMessage">Aún no se ha realizado ninguna consulta.</div>

      <div class="kvs" id="kvOut">
        <div class="kv"><div class="k">CEDULA</div><div class="v" id="outCED">—</div></div>
        <div class="kv"><div class="k">NOMBRE</div><div class="v" id="outNOM">—</div></div>
        <div class="kv"><div class="k">Fecha de Nacimiento</div><div class="v" id="outFN">—</div></div>
        <div class="kv"><div class="k">SEXO</div><div class="v" id="outSX">—</div></div>
        <div class="kv"><div class="k">bot_script_id</div><div class="v" id="outBID">—</div></div>
        <div class="kv"><div class="k">Interpretación</div><div class="v" id="outINT">—</div></div>
      </div>

      <div class="foot">
        Nota: Configura las credenciales y el endpoint en el entorno de despliegue; este archivo no expone información sensible.
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);

    const state = {
      cedula: el('cedula'),
      btnSend: el('btnSend'),
      btnClear: el('btnClear'),
      status: el('status'),
      resultMessage: el('resultMessage'),
      outCED: el('outCED'),
      outNOM: el('outNOM'),
      outFN: el('outFN'),
      outSX: el('outSX'),
      outBID: el('outBID'),
      outINT: el('outINT'),
    };

    function setStatus(text, kind = 'muted') {
      state.status.className = `pill ${kind}`;
      state.status.textContent = text;
    }

    function maskCed(ced) {
      return ced ? ced.replace(/\d(?=\d{4})/g, '•') : '';
    }

    function normalizeConfig(raw = {}) {
      const endpoint = typeof raw.endpoint === 'string' ? raw.endpoint.trim() : '';
      const timeoutMs = Number(raw.timeoutMs ?? raw.timeout ?? 15000);
      const idSuccess = Number(raw.idSuccess ?? 100);
      const idNotFound = Number(raw.idNotFound ?? 14);

      let authHeader = '';
      const fromAuthHeader = raw.authHeader || raw.basicAuth;
      if (typeof fromAuthHeader === 'string' && fromAuthHeader.trim()) {
        authHeader = fromAuthHeader.trim().startsWith('Basic ')
          ? fromAuthHeader.trim()
          : `Basic ${fromAuthHeader.trim()}`;
      } else if (raw.user && raw.pass) {
        authHeader = 'Basic ' + btoa(`${raw.user}:${raw.pass}`);
      }

      return { endpoint, timeoutMs, idSuccess, idNotFound, authHeader };
    }

    let activeConfig = normalizeConfig(window.SD_API_CONFIG || {});

    window.setSdApiConfig = function setSdApiConfig(cfg) {
      activeConfig = normalizeConfig(cfg);
      setStatus('Configuración actualizada', 'ok');
    };

    function getConfig() {
      return activeConfig;
    }

    function validateCedula(raw) {
      const digits = (raw || '').replace(/\D/g, '');
      if (digits.length !== 11) return { ok: false, msg: 'La cédula debe tener 11 dígitos.' };
      return { ok: true, digits };
    }

    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 15000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        return await fetch(resource, { ...options, signal: controller.signal, mode: 'cors' });
      } finally {
        clearTimeout(id);
      }
    }

    function resetOutputs() {
      [state.outCED, state.outNOM, state.outFN, state.outSX, state.outBID, state.outINT].forEach(e => {
        e.textContent = '—';
      });
      state.resultMessage.textContent = 'Aún no se ha realizado ninguna consulta.';
    }

    state.btnClear.addEventListener('click', () => {
      state.cedula.value = '';
      resetOutputs();
      setStatus('Campos limpiados', 'muted');
    });

    state.btnSend.addEventListener('click', async () => {
      const cfg = getConfig();
      const v = validateCedula(state.cedula.value);
      if (!v.ok) {
        setStatus(v.msg, 'err');
        return;
      }

      if (!cfg.endpoint || !cfg.authHeader) {
        setStatus('Configura endpoint y credenciales antes de consultar.', 'err');
        state.resultMessage.textContent = 'Define window.setSdApiConfig({ endpoint, authHeader }) antes de usar la herramienta.';
        return;
      }

      setStatus('Consultando...', 'warn');
      state.btnSend.disabled = true;
      const t0 = performance.now();

      const payload = {
        cedula: v.digits,
        bot_script_id_success: cfg.idSuccess,
        bot_script_id_not_found: cfg.idNotFound,
      };

      try {
        const res = await fetchWithTimeout(cfg.endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': cfg.authHeader,
          },
          body: JSON.stringify(payload),
          timeout: cfg.timeoutMs,
        });

        const ct = res.headers.get('content-type') || '';
        let dataObj = null;

        if (ct.includes('application/json')) {
          dataObj = await res.json();
        } else {
          const text = await res.text();
          try {
            dataObj = JSON.parse(text);
          } catch {
            dataObj = null;
          }
        }

        const CED = dataObj?.CEDULA ?? dataObj?.cedula ?? null;
        const NOM = dataObj?.NOMBRE ?? null;
        const FN = dataObj?.['Fecha de Nacimiento'] ?? dataObj?.fecha_nacimiento ?? null;
        const SX = dataObj?.SEXO ?? null;
        const BID = dataObj?.bot_script_id ?? null;

        state.outCED.textContent = CED ? `${maskCed(CED)} (${CED.length} dígitos)` : '—';
        state.outNOM.textContent = NOM || '—';
        state.outFN.textContent = FN || '—';
        state.outSX.textContent = SX || '—';
        state.outBID.textContent = BID ?? '—';

        const idOk = cfg.idSuccess;
        const idNF = cfg.idNotFound;
        let interp = '—';
        let kind = 'muted';

        if (BID === idOk) {
          interp = 'Registro encontrado';
          kind = 'ok';
          state.resultMessage.textContent = 'La cédula consultada está registrada en el padrón.';
        } else if (BID === idNF) {
          interp = 'No encontrado';
          kind = 'warn';
          state.resultMessage.textContent = 'No se encontraron datos para la cédula ingresada.';
        } else if (BID != null) {
          interp = `Código no previsto: ${BID}`;
          kind = 'warn';
          state.resultMessage.textContent = 'Respuesta recibida con código no previsto, revisa la configuración.';
        } else if (!res.ok) {
          interp = `HTTP ${res.status} ${res.statusText}`;
          kind = 'err';
          state.resultMessage.textContent = 'No se pudo obtener información, revisa la respuesta del servicio.';
        } else {
          state.resultMessage.textContent = 'Consulta realizada, verifica los campos mostrados.';
        }

        state.outINT.textContent = interp;
        const elapsed = performance.now() - t0;
        setStatus(res.ok ? `Respuesta recibida en ${elapsed.toFixed(0)} ms` : 'Error HTTP recibido', kind);

      } catch (err) {
        resetOutputs();
        state.resultMessage.textContent = 'Fallo en la solicitud (timeout, red o CORS).';
        setStatus('Fallo en la solicitud.', 'err');
        console.error(err);
      } finally {
        state.btnSend.disabled = false;
      }
    });

    resetOutputs();
  </script>
</body>
</html>
